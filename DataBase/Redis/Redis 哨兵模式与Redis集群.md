# 1. Redis哨兵模式:

## 1.1 sentinel的功能:

1. 监控,sentinel会不断的检查你的主服务器和从服务器是否运行正常

2. 提醒.当被监控的某个redis服务器出现问题时,sentinel可以通过API向管理员或者其他应用程序发送通知

3. 自动故障迁移

## 1.2 服务器连接:

### 1.2.1 sentinel通过用户配置的配置文件来发现主服务器

sentinel会与被监视的主服务器创建两个网络连接:

1. 命令连接用于向主服务器发送命令

2. 订阅连接用于订阅指定的频道,从而发现



### 1.1.1 发现并连接从服务器:



### 1.1.1 发现其他sentinel:

sentinel会通过命令连接想被监视的主从服务器发送hello信息,该消息包含sentinel的IP,端口号,ID等内容,以此来向其他sentinel 宣告自己的存在,于此同时sentinel会通过订阅连接接受其他sentinel的hello信息,以此来发现监视同一个主服务器的其他sentinel



### 1.1.1 多个sentinel之间的连接:

sentinel之间只会互相创建命令连接,用于进行通信,因为已经有主从服务器作为发送和接受hello信息的中介,所以sentinel之间不会创建订阅连接

## 1.1 failover:

一次故障转移的步骤:



*1.*  *发现主服务器已经进入客观下线状态。*

*2.*  *基于**Raft leader election* *协议* *，* *进行投票选举*

*3.*  *如果当选失败，那么在设定的故障迁移超时时间的两倍之后，重新尝试当选。* *如果当选成功，* *那么执行以下步骤。*

*4.*  *选出一个从服务器，并将它升级为主服务器。*

*5.*  *向被选中的从服务器发送* *SLAVEOF NO ONE* *命令，让它转变为主服务器。*

*6.*  *通过发布与订阅功能，* *将更新后的配置传播给所有其他* *Sentinel* *，其他* *Sentinel* *对它们自己的配置进行更新。*

*7.*  *向已下线主服务器的从服务器发送* *SLAVEOF* *命令，让它们去复制新的主服务器。*

*8.*  *当所有从服务器都已经开始复制新的主服务器时，* *leader Sentinel* *终止这次故障迁移操作。*

##  1.2部署sentinel:

# 2. Redis cluster

- redis集群是一个可以在多个redis节点之间进行数据共享的设施

- redis集群不支持哪些需要同时处理多个键的redis命令,因为执行这些命令需要在多个redis节点之间移动数据,并且在高负载的情况下,这些命令将降低redis集群的性能,并导致不可预测的行为

- redis集群通过分区来提供一定程度的可用性,即使集群中有一部分节点失效或者无法进行通讯,集群也可以继续处理命令请求,将数据自动切分到多个节点的能力

- 当集群中的一部分节点失效或者无法进行通讯时,仍然可以继续处理命令请求的能力

##  redis集群数据共享

redis集群使用数据分片,而非一致性hash来实现,一个redis集群包含16384个哈希槽,数据库中的每个键都属于这16384哈希槽其中一个,集群使用公式来计算键值属于哪个槽

*节点* *A* *负责处理* *0* *号至* *5500* *号哈希槽。*

*节点* *B* *负责处理* *5501* *号至* *11000* *号哈希槽。*

*节点* *C* *负责处理* *11001* *号至* *16384* *号哈希槽。*

## 集群运行机制

- 所有的redis节点彼此互联ping-pong机制,内部使用二进制协议传输速度和带宽

- 节点的fail是通过集群中超过半数的master节点检测失效时才失效

- 客户端与redis节点直连,不需要中间proxy层,客户顿不需要连接集群中所有节点,连接集群中任何一个可用节点即可

把所有的物理节点映射到哈希槽上,cluster负责维护



# Reference

https://blog.51cto.com/u_13520772/2109405